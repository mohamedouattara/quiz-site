(function(){const b=document.createElement("link").relList;if(b&&b.supports&&b.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))y(s);new MutationObserver(s=>{for(const p of s)if(p.type==="childList")for(const B of p.addedNodes)B.tagName==="LINK"&&B.rel==="modulepreload"&&y(B)}).observe(document,{childList:!0,subtree:!0});function d(s){const p={};return s.integrity&&(p.integrity=s.integrity),s.referrerPolicy&&(p.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?p.credentials="include":s.crossOrigin==="anonymous"?p.credentials="omit":p.credentials="same-origin",p}function y(s){if(s.ep)return;s.ep=!0;const p=d(s);fetch(s.href,p)}})();console.log("app.js: Script loading started");window.onerror=function(L,b,d,y,s){return console.error("Global Error caught:",L,"at",d,":",y),alert("Error: "+L+`
Line: `+d),!1};document.addEventListener("DOMContentLoaded",()=>{console.log("app.js: DOMContentLoaded reached"),window.pdfjsLib&&(pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js");const L={upload:document.getElementById("upload-section"),loading:document.getElementById("loading-section"),quiz:document.getElementById("quiz-section"),results:document.getElementById("results-section")},b=document.getElementById("file-input"),d=document.getElementById("drop-zone"),y=document.getElementById("generate-btn"),s=document.getElementById("text-paste"),p=document.getElementById("question-container"),B=document.getElementById("next-btn"),Z=document.getElementById("progress-bar"),ye=document.getElementById("question-count"),he=document.getElementById("final-score"),ve=document.getElementById("correct-count"),we=document.getElementById("incorrect-count"),ee=document.getElementById("review-list"),xe=document.getElementById("language-select"),te=document.getElementById("recommendations"),Ee=document.getElementById("chips-wrapper"),F=document.querySelectorAll(".type-btn"),J=document.getElementById("image-input"),ne=document.getElementById("image-preview-container"),Ie=document.getElementById("image-preview"),ke=document.getElementById("remove-img-btn"),be=document.getElementById("browse-btn"),R=document.getElementById("upload-title"),_=document.getElementById("upload-subtitle"),G=document.getElementById("text-input-container"),U=document.getElementById("url-input-container"),Be=document.getElementById("url-input"),z=document.getElementById("skip-btn"),oe=document.getElementById("skipped-count");let f=[],g=0,Q=0,D=[],H,j=0,c="text",C=null;const re=document.getElementById("add-profile-btn"),se=document.getElementById("reset-all-btn"),ie=document.getElementById("close-modal-btn"),V=document.getElementById("profile-modal"),ae=document.getElementById("modal-profile-list"),le=document.getElementById("player-profile");let h=[],v=0;const ce=()=>({username:null,xp:0,level:1,streak:0,lastDate:null,topics:[]});function x(e){Object.values(L).forEach(t=>t.classList.remove("active")),L[e].classList.add("active"),window.scrollTo(0,0)}F.forEach(e=>{e.addEventListener("click",()=>{F.forEach(t=>t.classList.remove("active")),e.classList.add("active"),c=e.dataset.type,Se()})});function Se(){c==="image"?(R.textContent="Upload your Image or Scan",_.textContent="Supports JPG, PNG, WEBP",G.style.display="none",d.style.display="block",U.style.display="none"):c==="url"?(R.textContent="Generate from URL",_.textContent="Enter the link to a webpage or article",G.style.display="none",d.style.display="none",U.style.display="block"):(R.textContent="Drag & drop your notes here",_.textContent="Supports .txt, .md, .pdf or paste your text below",G.style.display="block",d.style.display="block",U.style.display="none")}be.addEventListener("click",()=>{c==="image"?J.click():b.click()}),d.addEventListener("dragover",e=>{e.preventDefault(),d.classList.add("drag-over")}),d.addEventListener("dragleave",()=>{d.classList.remove("drag-over")}),d.addEventListener("drop",e=>{e.preventDefault(),d.classList.remove("drag-over");const t=e.dataTransfer.files;t.length>0&&pe(t[0])});function de(){const e=["Quantum","Cyber","Atomic","Prismatic","Digital","Logic","Hyper","Nova","Cerebral","Infinite"],t=["Scholar","Explorer","Sage","Architect","Alchemist","Pioneer","Wiz","Master","Seeker","Mind"],n=e[Math.floor(Math.random()*e.length)],r=t[Math.floor(Math.random()*t.length)];return`${n} ${r}`}function Le(){const e=ce();e.username=de(),h.push(e),v=h.length-1,P(),N(),q(),W()}function Ce(e){v=e,P(),N(),q(),W(),V.classList.remove("active")}function Pe(){const e=localStorage.getItem("quiz_player_profiles"),t=localStorage.getItem("quiz_active_profile_idx");if(e)h=JSON.parse(e),v=parseInt(t)||0;else{const n=localStorage.getItem("quiz_user_stats"),r=JSON.parse(localStorage.getItem("quiz_topics")||"[]");if(n){const o=JSON.parse(n);o.topics=r,h=[o]}else{const o=ce();o.username=de(),h=[o]}v=0}Te(),N(),q()}function P(){localStorage.setItem("quiz_player_profiles",JSON.stringify(h)),localStorage.setItem("quiz_active_profile_idx",v)}function T(){return h[v]}function Te(){const e=T();if(!e)return;const t=new Date().toDateString();if(e.lastDate===t)return;const n=new Date;n.setDate(n.getDate()-1);const r=n.toDateString();e.lastDate===r?e.streak++:e.streak=1,e.lastDate=t,P()}function qe(e){const t=T();t&&(t.xp+=e,t.level=Math.floor(t.xp/100)+1,P(),N())}function N(){const e=T();if(!e)return;const t={streak:document.getElementById("nav-streak"),level:document.getElementById("nav-level"),xpVal:document.getElementById("nav-xp-val"),xpBar:document.getElementById("nav-xp-bar"),name:document.getElementById("player-name")},n=e.xp%100;t.streak&&(t.streak.textContent=e.streak),t.level&&(t.level.textContent=e.level),t.xpVal&&(t.xpVal.textContent=n),t.xpBar&&(t.xpBar.style.width=`${n}%`),t.name&&(t.name.textContent=e.username)}function W(){ae.innerHTML=h.map((e,t)=>`
            <div class="profile-item ${t===v?"active":""}" data-index="${t}">
                <div class="avatar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 1rem;">${e.username}</div>
                    <div style="font-size: 0.8rem; color: var(--text-dim);">Niveau ${e.level} â€¢ ${e.xp} XP</div>
                </div>
                ${t===v?'<span class="text-success" style="font-size: 0.8rem;">Actif</span>':""}
            </div>
        `).join(""),ae.querySelectorAll(".profile-item").forEach(e=>{e.onclick=()=>Ce(parseInt(e.dataset.index))})}function $e(){confirm("âš ï¸ ÃŠtes-vous sÃ»r de vouloir supprimer TOUTES les donnÃ©es ? Cette action supprimera tous les profils, votre progression et vos recommandations. C'est irrÃ©versible.")&&confirm("DerniÃ¨re chance : Souhaitez-vous vraiment tout rÃ©initialiser ?")&&(localStorage.clear(),window.location.reload())}le&&(le.onclick=()=>{W(),V.classList.add("active")}),ie&&(ie.onclick=()=>V.classList.remove("active")),re&&(re.onclick=Le),se&&(se.onclick=$e);const ue=document.querySelector('a[href="#how-it-works"]');ue&&(ue.onclick=e=>{activeSection!=="upload"&&(x("upload"),setTimeout(()=>{document.getElementById("how-it-works")?.scrollIntoView({behavior:"smooth"})},100))}),Pe(),b.addEventListener("change",e=>{e.target.files.length>0&&pe(e.target.files[0])}),J.addEventListener("change",e=>{e.target.files.length>0&&Ae(e.target.files[0])}),ke.addEventListener("click",()=>{C=null,ne.style.display="none",J.value=""});function Ae(e){const t=new FileReader;t.onload=n=>{C=n.target.result,Ie.src=C,ne.style.display="block"},t.readAsDataURL(e)}async function pe(e){if(e.type==="application/pdf")try{s.value="Extracting text from PDF... Please wait.",y.disabled=!0;const t=await De(e);s.value=t,y.disabled=!1}catch(t){console.error("PDF Error:",t),alert("Error reading PDF file: "+t.message),s.value="",y.disabled=!1}else{const t=new FileReader;t.onload=n=>{s.value=n.target.result},t.readAsText(e)}}async function Oe(e){try{const t=await fetch(`https://r.jina.ai/${e}`);if(!t.ok)throw new Error("Failed to fetch URL content");return await t.text()}catch(t){throw console.error("URL Fetch Error:",t),new Error("Could not read the URL. Please make sure the link is public.")}}async function De(e){const t=await e.arrayBuffer(),r=await pdfjsLib.getDocument({data:t}).promise;let o="";for(let m=1;m<=r.numPages;m++){const $=(await(await r.getPage(m)).getTextContent()).items.map(A=>A.str);o+=$.join(" ")+`
`}return o}y.addEventListener("click",async()=>{console.log("Generate Quiz button clicked, type:",c);let e="";if(c==="text"){if(e=s.value.trim(),!e){alert("Please provide some notes or paste text first!");return}}else if(c==="image"){if(!C){alert("Please upload an image or scan first!");return}e="Analyze the provided image."}else if(c==="url"){const n=Be.value.trim();if(!n){alert("Please enter a website URL!");return}x("loading");try{e=await Oe(n)}catch(r){x("upload"),alert(r.message);return}}let t="";try{t="AIzaSyD-sB57A0WnjX3JxbReCd3WaMkYxU10Hns"}catch{console.warn("Vite environment variables not available. Falling back to UI check.")}if(t||(t=document.getElementById("api-key")?.value.trim()),!t){alert("Gemini API Key is missing. Please check your .env file or the configuration."),c==="url"&&x("upload");return}c!=="url"&&x("loading");try{if(f=await ze(e,t),!f||f.length===0)throw new Error("No questions generated.");je()}catch(n){console.error(n),alert("Error generating quiz: "+n.message),x("upload")}});async function ze(e,t){const n=document.getElementById("question-count-select").value||5,r=xe.value||"French",o="https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent",i={contents:[{parts:[{text:`
            You are a Quiz Generator specialized in study materials. 
            ${c==="image"?"Analyze the attached image.":"Analyze the input text below."}
            Generate a quiz with exactly ${n} multiple-choice questions.
            The language of the quiz (questions, options, explanations and title) MUST be ${r}.
            Include a "reference" or "explanation" for each question to legitimize the answer.
            IMPORTANT: Return ONLY raw JSON. No conversational text.
            Properly escape all strings. Do NOT use unescaped newlines within JSON values.
            
            JSON Structure:
            {
              "quiz_title": "Concise title",
              "questions": [
                {
                  "question": "text",
                  "options": ["A", "B", "C", "D"],
                  "correct": 0,
                  "explanation": "reference"
                }
              ]
            }

            ${c==="text"?`Input text:
`+e:"Base your questions on the provided image."}
        `}]}],generationConfig:{temperature:.7,topK:40,topP:.95,maxOutputTokens:2048}};if(c==="image"&&C){const u=C.match(/^data:(image\/[a-zA-Z]+);base64,(.+)$/);u&&i.contents[0].parts.push({inline_data:{mime_type:u[1],data:u[2]}})}try{let u=function(a){let l=a.replace(/```(?:json)?/gi,"").trim();const E=l.indexOf("{"),S=l.indexOf("["),w=l.lastIndexOf("}"),X=l.lastIndexOf("]");if(E===-1&&S===-1)throw new Error("The AI response did not contain a valid JSON structure.");let I=-1,k=-1;if(E!==-1&&(S===-1||E<S)?(I=E,k=w):S!==-1&&(I=S,k=X),I!==-1&&(k===-1||k<I)&&(console.warn("JSON appears truncated, capturing partial structure..."),k=l.length-1),I===-1)throw new Error("Could not isolate JSON structure.");return l.substring(I,k+1).trim().replace(/,\s*([\}\]])/g,"$1").replace(/([\}\]])\s*([\{\[])/g,"$1, $2").replace(/[\u201C\u201D\u2018\u2019]/g,'"')};console.log("Sending request to Gemini API (Multimodal:",c==="image","):",o);const $=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":t},body:JSON.stringify(i)});if(!$.ok){let a=`HTTP Error ${$.status}`;try{a=(await $.json()).error?.message||a}catch{}throw console.error("Gemini API Error:",a),new Error(a)}const A=await $.json();if(!A.candidates||A.candidates.length===0||!A.candidates[0].content)throw new Error("No candidates returned from AI. This may be due to safety filters.");let fe=A.candidates[0].content.parts[0].text;console.log("Gemini Raw Response:",fe);const K=u(fe);try{let a;try{a=JSON.parse(K)}catch(S){console.warn("Initial JSON parse failed, attempting auto-repair...");let w=K;const X=(w.match(/\{/g)||[]).length,I=(w.match(/\}/g)||[]).length,k=(w.match(/\[/g)||[]).length,ge=(w.match(/\]/g)||[]).length;for(let O=0;O<k-ge;O++)w+="]";for(let O=0;O<X-I;O++)w+="}";try{a=JSON.parse(w),console.log("Auto-repair successful!")}catch{throw S}}let l=[],E="Quiz";if(Array.isArray(a)?(l=a,E=l[0]?.question?.split(" ").slice(0,8).join(" ")||"Quiz"):(l=a.questions||[],E=a.quiz_title||l[0]?.question?.split(" ").slice(0,8).join(" ")||"Quiz"),!l||l.length===0)throw new Error("The AI returned an empty question list.");return _e(E),l}catch(a){throw console.error("JSON Parse Error:",a),console.error("Failed string:",K),new Error(`AI format error: ${a.message}. Try reducing the question count if this persists.`)}}catch(u){throw u.name==="TypeError"&&u.message==="Failed to fetch"?new Error("Network error: Could not reach Gemini API."):u}}function je(){g=0,Q=0,D=[],j=0,Ne(),Y(),x("quiz")}function Ne(){const e=document.getElementById("timer");clearInterval(H),H=setInterval(()=>{j++;const t=Math.floor(j/60).toString().padStart(2,"0"),n=(j%60).toString().padStart(2,"0");e.textContent=`${t}:${n}`},1e3)}function Y(){const e=f[g];ye.textContent=`Question ${g+1} of ${f.length}`,Z.style.width=`${g/f.length*100}%`,p.innerHTML=`
            <h2>${e.question}</h2>
            <div class="options-grid">
                ${e.options.map((t,n)=>`
                    <div class="option" data-index="${n}">
                        <div class="option-letter">${String.fromCharCode(65+n)}</div>
                        <div class="option-text">${t}</div>
                    </div>
                `).join("")}
            </div>
        `,document.querySelectorAll(".option").forEach(t=>{t.addEventListener("click",Me)}),B.disabled=!0}z&&z.addEventListener("click",()=>{D[g]=null,g++,g<f.length?Y():me()});function Me(e){const t=parseInt(e.currentTarget.dataset.index),n=f[g];document.querySelectorAll(".option").forEach(o=>o.classList.remove("selected","correct","incorrect")),e.currentTarget.classList.add("selected");const r=document.querySelectorAll(".option");t===n.correct?e.currentTarget.classList.add("correct"):(e.currentTarget.classList.add("incorrect"),r[n.correct].classList.add("correct")),r.forEach(o=>o.style.pointerEvents="none"),D[g]=t,B.disabled=!1,z&&(z.disabled=!1),t===n.correct&&Q++}B.addEventListener("click",()=>{g++,g<f.length?Y():me()});function me(){clearInterval(H),Z.style.width="100%";const e=Q,t=D.filter(u=>u===null).length,n=f.length-e-t,r=Math.round(e/f.length*100);he.textContent=r,ve.textContent=e,we.textContent=n,oe&&(oe.textContent=t);const o=document.getElementById("result-message");o&&(o.textContent=Je(r));const m=document.querySelector(".score-circle");m&&m.style.setProperty("--score-percent",r);const i=e*10+(r===100?50:0);qe(i),Fe(),x("results")}function Fe(){ee.innerHTML="",f.forEach((e,t)=>{const n=D[t],r=n===null,o=n===e.correct,m=document.createElement("div");let i="wrong";o&&(i="right"),r&&(i="skipped"),m.className=`review-item ${i}`,m.innerHTML=`
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <p style="margin: 0;">${t+1}. ${e.question}</p>
                    ${e.explanation?`<span class="info-icon" data-tooltip="${e.explanation.replace(/"/g,"&quot;")}">i</span>`:""}
                </div>
                <div class="answer-info" style="margin-top: 0.5rem;">
                    <span class="text-success">Correct answer: ${e.options[e.correct]}</span><br>
                    ${r?'<span style="color: var(--text-dim);">Skipped</span>':o?"":`<span class="text-danger">Your answer: ${e.options[n]}</span>`}
                </div>
            `,ee.appendChild(m)})}function Je(e){return e===100?"Perfect! You've mastered this topic! ðŸ†":e>=80?"Impressive! You have a very strong grasp of these concepts. âœ¨":e>=60?"Good job! You're on the right track, just a few things to polish. ðŸ‘":e>=40?"Not bad, but there's room for improvement. Keep studying! ðŸ“š":"Keep practicing! Review the explanations below to improve your score. ðŸ’ª"}const M=document.getElementById("feedback-form"),Re=document.getElementById("feedback-success");M&&M.addEventListener("submit",async e=>{e.preventDefault(),console.log("Feedback form submitted");let t="";try{t="xbdlqlyj"}catch{console.warn("Vite environment variables not available for Formspree.")}t||(t=document.getElementById("formspree-id")?.value.trim());const n=document.getElementById("feedback-email").value,r=document.getElementById("feedback-msg").value,o=M.querySelector('button[type="submit"]'),m=o.textContent;o.textContent="Sending...",o.disabled=!0;try{const i=await fetch(`https://formspree.io/f/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n,message:r})});if(i.ok)M.style.display="none",Re.style.display="block";else{const u=await i.json().catch(()=>({}));throw console.error("Formspree Error Status:",i.status),console.error("Formspree Error Detail:",u),new Error(`Failed to send feedback (Status: ${i.status})`)}}catch(i){console.error("Feedback Submission Exception:",i),alert(`Error sending feedback: ${i.message}. Please check your Formspree ID in .env.`)}finally{o.textContent=m,o.disabled=!1}});function _e(e){if(!e||e.length<3)return;const t=T();t.topics||(t.topics=[]),t.topics.includes(e)||(t.topics.unshift(e),h[v].topics=t.topics.slice(0,6),P(),q())}function Ge(e){const t=T();t.topics=t.topics.filter(n=>n!==e),P(),q()}function q(){const t=T()?.topics||[];if(t.length===0){te.style.display="none";return}te.style.display="block",Ee.innerHTML=t.map(n=>`
            <div class="chip" data-topic="${n}">
                <span class="chip-text">${n}</span>
                <span class="chip-delete" title="Supprimer">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="pointer-events: none;"><line x1="18" y1="6" x2="6" y1="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
        `).join(""),document.querySelectorAll(".chip").forEach(n=>{n.addEventListener("click",r=>{const o=n.dataset.topic;if(r.target.closest(".chip-delete")){r.stopPropagation(),Ge(o);return}c==="image"&&F[0].click(),s.value=`Discuss the key concepts of: ${o}`,s.focus(),s.scrollIntoView({behavior:"smooth",block:"center"})})})}q()});
